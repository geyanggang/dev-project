<!--pages/my-tasks/my-tasks.wxml-->
<view class="container">
  <!-- Tab切换 -->
  <view class="tabs">
    <view class="tab-item {{activeTab === 'published' ? 'active' : ''}}" bindtap="switchTab" data-tab="published">
      我发布的
    </view>
    <view class="tab-item {{activeTab === 'grabbed' ? 'active' : ''}}" bindtap="switchTab" data-tab="grabbed">
      我接的单
    </view>
  </view>

  <!-- 任务列表 -->
  <view class="task-list">
    <view class="task-card" wx:for="{{tasks}}" wx:key="_id" bindtap="goToTaskDetail" data-id="{{item._id}}">
      <!-- 任务头部 -->
      <view class="task-header">
        <view class="task-title">{{item.title}}</view>
        <view class="badge badge-{{item.status}}">{{statusText[item.status]}}</view>
      </view>

      <!-- 任务信息 -->
      <view class="task-info">
        <view class="info-item">
          <image src="/images/money.png" mode="aspectFit"></image>
          <text class="price">¥{{item.finalPrice || item.aiSuggestedPrice}}</text>
        </view>
        <view class="info-item">
          <image src="/images/time.png" mode="aspectFit"></image>
          <text>{{item.deadline}}</text>
        </view>
      </view>

      <!-- 对方信息 -->
      <view class="user-info" wx:if="{{item.otherUserInfo}}">
        <image class="avatar" src="{{item.otherUserInfo.avatar}}" mode="aspectFill"></image>
        <view class="user-details">
          <view class="nickname">{{item.otherUserInfo.nickname}}</view>
          <view class="rating">
            <text class="stars">★ {{item.otherUserInfo.rating || 5.0}}</text>
          </view>
        </view>
      </view>

      <!-- 操作按钮 -->
      <view class="task-actions">
        <button class="btn-outline btn-sm" wx:if="{{activeTab === 'published' && item.status === 'pending'}}" 
                catchtap="cancelTask" data-id="{{item._id}}">
          取消任务
        </button>
        <button class="btn-primary btn-sm" wx:if="{{activeTab === 'published' && item.status === 'grabbed'}}" 
                catchtap="confirmGrab" data-id="{{item._id}}">
          确认并支付
        </button>
        <button class="btn-primary btn-sm" wx:if="{{activeTab === 'published' && item.status === 'in-progress'}}" 
                catchtap="confirmComplete" data-id="{{item._id}}">
          确认验收
        </button>
        <button class="btn-secondary btn-sm" wx:if="{{activeTab === 'grabbed' && item.status === 'in-progress'}}" 
                catchtap="submitComplete" data-id="{{item._id}}">
          提交完成
        </button>
      </view>
    </view>
  </view>

  <!-- 空状态 -->
  <view class="empty-state" wx:if="{{tasks.length === 0 && !loading}}">
    <image src="/images/empty.png" mode="aspectFit"></image>
    <view class="empty-text">
      {{activeTab === 'published' ? '暂无发布的任务' : '暂无接单记录'}}
    </view>
  </view>

  <!-- 加载状态 -->
  <view class="loading" wx:if="{{loading}}">
    <text>加载中...</text>
  </view>
</view>

