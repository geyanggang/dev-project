<!--pages/task-detail/task-detail.wxml-->
<view class="container">
  <view class="task-detail" wx:if="{{task}}">
    <!-- 任务头部 -->
    <view class="card task-header">
      <view class="title-row">
        <view class="task-title">{{task.title}}</view>
        <view class="badge badge-{{task.status}}">{{statusText[task.status]}}</view>
      </view>
      
      <view class="price-section">
        <view class="price-label">任务金额</view>
        <view class="price-value">¥{{task.finalPrice || task.aiSuggestedPrice}}</view>
        <view class="ai-price" wx:if="{{task.aiSuggestedPrice}}">
          <text>AI参考价: ¥{{task.aiSuggestedPrice}}</text>
        </view>
      </view>

      <view class="info-row">
        <view class="info-item">
          <image src="/images/time.png" mode="aspectFit"></image>
          <text>截止: {{task.deadline}}</text>
        </view>
        <view class="info-item">
          <image src="/images/calendar.png" mode="aspectFit"></image>
          <text>发布: {{task.createdAt}}</text>
        </view>
      </view>
    </view>

    <!-- 任务描述 -->
    <view class="card">
      <view class="section-title">任务描述</view>
      <view class="task-description">{{task.description}}</view>
    </view>

    <!-- 技术栈 -->
    <view class="card">
      <view class="section-title">技术栈要求</view>
      <view class="tech-stack">
        <view class="tag tag-primary" wx:for="{{task.techStack}}" wx:key="index">
          {{item}}
        </view>
      </view>
    </view>

    <!-- 预算范围 -->
    <view class="card" wx:if="{{task.budgetRange}}">
      <view class="section-title">预算范围</view>
      <view class="budget-range">
        ¥{{task.budgetRange.min}} - ¥{{task.budgetRange.max}}
      </view>
    </view>

    <!-- 发布者信息 -->
    <view class="card publisher-info">
      <view class="section-title">发布者</view>
      <view class="user-card">
        <image class="avatar" src="{{task.customerInfo.avatar}}" mode="aspectFill"></image>
        <view class="user-info">
          <view class="nickname">{{task.customerInfo.nickname}}</view>
          <view class="user-stats">
            <view class="stat-item">
              <text class="stars">★ {{task.customerInfo.rating || 5.0}}</text>
            </view>
            <view class="stat-item">
              <text>已发布{{task.customerInfo.completedOrders || 0}}单</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 接单者信息 -->
    <view class="card" wx:if="{{task.developerId && task.developerInfo}}">
      <view class="section-title">接单程序员</view>
      <view class="user-card">
        <image class="avatar" src="{{task.developerInfo.avatar}}" mode="aspectFill"></image>
        <view class="user-info">
          <view class="nickname">{{task.developerInfo.nickname}}</view>
          <view class="user-stats">
            <view class="stat-item">
              <text class="stars">★ {{task.developerInfo.rating || 5.0}}</text>
            </view>
            <view class="stat-item">
              <text>已完成{{task.developerInfo.completedOrders || 0}}单</text>
            </view>
          </view>
          <view class="skills">
            <view class="tag" wx:for="{{task.developerInfo.skills}}" wx:key="index">
              {{item}}
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 底部操作栏 -->
  <view class="bottom-bar">
    <!-- 程序员抢单 -->
    <button class="btn-primary action-btn" 
            wx:if="{{userType === 'developer' && task.status === 'pending'}}"
            bindtap="grabTask">
      立即接单
    </button>

    <!-- 客户确认接单 -->
    <button class="btn-primary action-btn" 
            wx:if="{{userType === 'customer' && task.status === 'grabbed' && isMyTask}}"
            bindtap="confirmGrab">
      确认接单并支付
    </button>

    <!-- 客户标记完成 -->
    <button class="btn-primary action-btn" 
            wx:if="{{userType === 'customer' && task.status === 'in-progress' && isMyTask}}"
            bindtap="confirmComplete">
      确认验收
    </button>

    <!-- 程序员提交完成 -->
    <button class="btn-secondary action-btn" 
            wx:if="{{userType === 'developer' && task.status === 'in-progress' && isMyGrabbedTask}}"
            bindtap="submitComplete">
      提交完成
    </button>

    <!-- 联系对方 -->
    <button class="btn-outline action-btn" 
            wx:if="{{task.status !== 'pending' && (isMyTask || isMyGrabbedTask)}}"
            open-type="contact">
      联系对方
    </button>

    <!-- 取消任务 -->
    <button class="btn-outline action-btn" 
            wx:if="{{userType === 'customer' && task.status === 'pending' && isMyTask}}"
            bindtap="cancelTask">
      取消任务
    </button>
  </view>
</view>

